<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriCoach: Tu Guía Nutricional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="container"></div>

    <script>
        
        const appDiv = document.getElementById('app');

        // --- Datos y Base de Conocimiento 
        const initialQuestions = [
            { id: 'gender', label: 'Género', type: 'select', options: ['Hombre', 'Mujer'], required: true },
            { id: 'age', label: 'Edad (años)', type: 'number', required: true, min: 1, max: 120 },
            { id: 'height', label: 'Estatura (cm)', type: 'number', required: true, min: 50, max: 250 },
            { id: 'weight', label: 'Peso (kg)', type: 'number', required: true, min: 20, max: 500 },
            { id: 'ailments', label: 'Padecimientos (opcional, ej: Diabetes, Hipertensión, Alergias)', type: 'textarea', required: false },
        ];

        const nutritionalGoals = [
            { id: 'massGain', name: 'Aumento de Masa Muscular', image: 'https://png.pngtree.com/png-clipart/20240915/original/pngtree-man-with-muscular-physique-in-black-pants-png-image_16011016.png' },
            { id: 'weightControl', name: 'Control de Peso', image: 'https://png.pngtree.com/png-clipart/20240615/original/pngtree-measuring-waist-for-weight-loss-asian-woman-on-diet-and-slimming-png-image_15332677.png' },
            { id: 'generalWellness', name: 'Nutrición General y Bienestar', image: 'https://www.equilibra.ec/content/documentacion/celso-hernandez/20250305_145332dietas-variadas-equilibra.png' },
            { id: 'sportsPerformance', name: 'Mejora del Rendimiento Deportivo', image: 'https://dixsupps.com/wp-content/uploads/2025/01/Performance-sportive-1024x1024.webp' },
            { id: 'obesity', name: 'Obesidad', image: 'https://es.lilly.com/obesidad/assets/images/obesity/male-middle-east.png' },
            { id: 'undernutrition', name: 'Desnutrición', image: 'https://png.pngtree.com/png-clipart/20231111/original/pngtree-slim-person-young-adult-picture-image_13253260.png' },
        ];

        const expertQuestions = {
            massGain: [
                { id: 'activityLevel', label: '¿Cuál es tu nivel de actividad física?', type: 'radio', options: ['Sedentario', 'Ligero (1-3 días/sem ejercicio)', 'Moderado (3-5 días/sem ejercicio)', 'Activo (6-7 días/sem ejercicio)', 'Muy Activo (ejercicio intenso diario)'], required: true },
                { id: 'strengthTraining', label: '¿Tienes experiencia previa con entrenamiento de fuerza?', type: 'radio', options: ['Sí, con experiencia', 'Sí, principiante', 'No, nunca he entrenado fuerza'], required: true },
                { id: 'mealFrequency', label: '¿Cuántas comidas sueles hacer al día?', type: 'select', options: ['1-2', '3', '4-5', '6+'], required: true },
            ],
            weightControl: [
                { id: 'activityLevel', label: '¿Cuál es tu nivel de actividad física?', type: 'radio', options: ['Sedentario', 'Ligero (1-3 días/sem ejercicio)', 'Moderado (3-5 días/sem ejercicio)', 'Activo (6-7 días/sem ejercicio)', 'Muy Activo (ejercicio intenso diario)'], required: true },
                { id: 'emotionalEating', label: '¿Sueles comer por ansiedad o aburrimiento?', type: 'radio', options: ['Sí, frecuentemente', 'A veces', 'No, rara vez'], required: true },
                { id: 'processedFoods', label: '¿Con qué frecuencia consumes alimentos procesados o azúcares refinados?', type: 'radio', options: ['Diariamente', 'Varias veces a la semana', 'Ocasionalmente', 'Casi nunca'], required: true },
            ],
            generalWellness: [
                { id: 'activityLevel', label: '¿Cuál es tu nivel de actividad física?', type: 'radio', options: ['Sedentario', 'Ligero (1-3 días/sem ejercicio)', 'Moderado (3-5 días/sem ejercicio)', 'Activo (6-7 días/sem ejercicio)', 'Muy Activo (ejercicio intenso diario)'], required: true },
                { id: 'dietRestrictions', label: '¿Tienes alguna restricción dietética (vegetariano, vegano, sin gluten, etc.)?', type: 'textarea', required: false },
                { id: 'waterIntake', label: '¿Cuántos vasos de agua (250ml) sueles beber al día?', type: 'select', options: ['Menos de 4', '4-6', '7-8', 'Más de 8'], required: true },
            ],
            sportsPerformance: [
                { id: 'activityLevel', label: '¿Cuál es tu nivel de actividad física?', type: 'radio', options: ['Sedentario', 'Ligero (1-3 días/sem ejercicio)', 'Moderado (3-5 días/sem ejercicio)', 'Activo (6-7 días/sem ejercicio)', 'Muy Activo (ejercicio intenso diario)'], required: true },
                { id: 'sportType', label: '¿Qué tipo de deporte practicas principalmente?', type: 'text', required: true },
                { id: 'trainingFrequency', label: '¿Cuántas horas a la semana dedicas a tu deporte?', type: 'number', required: true, min: 1, max: 50 },
            ],
            obesity: [
                { id: 'activityLevel', label: '¿Cuál es tu nivel de actividad física?', type: 'radio', options: ['Sedentario', 'Ligero (1-3 días/sem ejercicio)', 'Moderado (3-5 días/sem ejercicio)', 'Activo (6-7 días/sem ejercicio)', 'Muy Activo (ejercicio intenso diario)'], required: true },
                { id: 'pastDiets', label: '¿Has intentado dietas antes? ¿Cuáles fueron los resultados?', type: 'textarea', required: false },
                { id: 'healthComplications', label: '¿Tienes complicaciones de salud relacionadas con el peso (ej: diabetes tipo 2, presión alta)?', type: 'radio', options: ['Sí', 'No'], required: true },
            ],
            undernutrition: [
                { id: 'activityLevel', label: '¿Cuál es tu nivel de actividad física?', type: 'radio', options: ['Sedentario', 'Ligero (1-3 días/sem ejercicio)', 'Moderado (3-5 días/sem ejercicio)', 'Activo (6-7 días/sem ejercicio)', 'Muy Activo (ejercicio intenso diario)'], required: true },
                { id: 'appetiteChanges', label: '¿Has notado cambios en tu apetito recientemente?', type: 'radio', options: ['Sí, ha disminuido', 'Sí, ha aumentado', 'No, sigue igual'], required: true },
                { id: 'fatigueWeakness', label: '¿Experimentas fatiga o debilidad constante?', type: 'radio', options: ['Sí, frecuentemente', 'A veces', 'No, rara vez'], required: true },
            ],
        };

        // --- Lógica 
        function calculateMetrics(gender, age, height, weight) {
            const heightInMeters = height / 100;
            const imc = weight / (heightInMeters * heightInMeters);

            let tmb;
            if (gender === 'Hombre') {
                tmb = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else if (gender === 'Mujer') {
                tmb = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            } else {
                tmb = ((10 * weight) + (6.25 * height) - (5 * age) + 5) * 0.95;
            }
            return { imc, tmb };
        }

        function getNutriSuggestions(userData, metrics, expertAnswers) {
            const { name, selectedGoal } = userData;
            const { imc, tmb } = metrics;
            const activityLevel = expertAnswers.activityLevel || 'Sedentario';
            let get;

            const activityFactors = {
                'Sedentario': 1.2,
                'Ligero (1-3 días/sem ejercicio)': 1.375,
                'Moderado (3-5 días/sem ejercicio)': 1.55,
                'Activo (6-7 días/sem ejercicio)': 1.725,
                'Muy Activo (ejercicio intenso diario)': 1.9,
            };
            get = tmb * activityFactors[activityLevel];

            let suggestion = `Hola ${name}, basándonos en tus datos y tu objetivo de **${nutritionalGoals.find(g => g.id === selectedGoal)?.name}**, aquí tienes una sugerencia personalizada:`;
            let weeklyGoals = [];
            let dietMethod = [];
            let disclaimer = "Esta guía es una sugerencia general y no reemplaza la consulta con un nutricionista o médico profesional. Siempre busca asesoramiento médico para condiciones de salud específicas.";

            switch (selectedGoal) {
                case 'massGain':
                    suggestion += `\nPara el **aumento de masa muscular**, te recomendamos un plan con un superávit calórico moderado (${Math.round(get + 300)}-${Math.round(get + 500)} kcal), priorizando la ingesta de proteínas y carbohidratos complejos.`;
                    weeklyGoals = [
                        { id: 1, text: 'Asegurar una ingesta adecuada de proteínas (1.8-2.2g/kg de peso corporal).' },
                        { id: 2, text: 'Consumir al menos 5 comidas pequeñas y nutritivas al día.' },
                        { id: 3, text: 'Aumentar la hidratación a 3-4 litros de agua diarios.' },
                        { id: 4, text: 'Priorizar carbohidratos complejos como arroz integral, avena y batata.' },
                    ];
                    dietMethod = [
                        '**Desayuno:** Avena con proteína en polvo, frutas y frutos secos.',
                        '**Media Mañana:** Batido de proteínas con plátano.',
                        '**Almuerzo:** Pechuga de pollo, arroz integral y vegetales.',
                        '**Media Tarde:** Yogur griego con miel y almendras.',
                        '**Cena:** Salmón, quinoa y una ensalada grande.',
                        '**Snack Nocturno (opcional):** Queso cottage o caseína.',
                        '**Principios:** Incluir proteínas en cada comida, no saltarse comidas, y asegurar suficientes calorías.',
                    ];
                    break;

                case 'weightControl':
                    let calorieDeficit = 0;
                    if (imc >= 25 && imc < 30) {
                        calorieDeficit = 500;
                        suggestion += `\nPara el **control de peso**, te sugerimos un déficit calórico de aproximadamente ${Math.round(get - calorieDeficit)} kcal, con énfasis en alimentos integrales y baja densidad calórica.`;
                    } else {
                        calorieDeficit = 300;
                        suggestion += `\nPara el **mantenimiento o leve pérdida de peso**, te sugerimos un plan con un leve déficit calórico de aproximadamente ${Math.round(get - calorieDeficit)} kcal, priorizando la saciedad y la calidad de los alimentos.`;
                    }

                    weeklyGoals = [
                        { id: 1, text: 'Reducir el consumo de azúcares añadidos y bebidas azucaradas.' },
                        { id: 2, text: 'Incorporar al menos 3 porciones de vegetales al día.' },
                        { id: 3, text: 'Aumentar la ingesta de fibra a través de cereales integrales y legumbres.' },
                        { id: 4, text: 'Beber al menos 2-3 litros de agua al día.' },
                    ];
                    dietMethod = [
                        '**Desayuno:** Huevos revueltos con espinacas y una tostada integral.',
                        '**Media Mañana:** Manzana con un puñado de almendras.',
                        '**Almuerzo:** Ensalada grande con atún o legumbres.',
                        '**Media Tarde:** Yogur natural.',
                        '**Cena:** Pescado al horno con brócoli al vapor.',
                        '**Principios:** Control de porciones, cocinar en casa, evitar fritos y comida rápida.',
                    ];
                    if (expertAnswers.emotionalEating === 'Sí, frecuentemente') {
                        suggestion += '\nConsidera buscar apoyo para manejar el comer emocional, quizás a través de técnicas de mindfulness o un profesional.';
                    }
                    if (expertAnswers.processedFoods === 'Diariamente') {
                        suggestion += '\nReducir drásticamente los alimentos procesados será clave.';
                    }
                    break;

                case 'generalWellness':
                    suggestion += `\nPara tu **bienestar general**, nos enfocaremos en un equilibrio nutricional, asegurando la ingesta de todos los macronutrientes y micronutrientes necesarios, manteniendo tu ingesta calórica alrededor de ${Math.round(get)} kcal.`;
                    weeklyGoals = [
                        { id: 1, text: 'Consumir una variedad de frutas y verduras de diferentes colores diariamente.' },
                        { id: 2, text: 'Asegurar una ingesta adecuada de proteínas magras.' },
                        { id: 3, text: 'Elegir fuentes de carbohidratos complejos y granos integrales.' },
                        { id: 4, text: 'Mantener una buena hidratación.' },
                    ];
                    dietMethod = [
                        '**Desayuno:** Smoothie verde con espinacas, plátano y leche vegetal.',
                        '**Media Mañana:** Puñado de frutos secos y una fruta.',
                        '**Almuerzo:** Bowl de quinoa con vegetales asados y garbanzos.',
                        '**Media Tarde:** Galletas de arroz con aguacate.',
                        '**Cena:** Sopa de lentejas con verduras.',
                        '**Principios:** Variedad, moderación, y escuchar las señales de hambre y saciedad de tu cuerpo.',
                    ];
                    if (userData.ailments) {
                        suggestion += `\n*Nota: Dados tus padecimientos (${userData.ailments}), es aún más importante consultar con un profesional para un plan totalmente seguro y eficaz.*`;
                    }
                    break;

                case 'sportsPerformance':
                    suggestion += `\nPara la **mejora del rendimiento deportivo**, tu nutrición debe apoyar tu entrenamiento. Te recomendamos una ingesta calórica elevada (${Math.round(get + 500)}-${Math.round(get + 1000)} kcal, ajustando según intensidad) con un énfasis en carbohidratos para energía y proteínas para la recuperación muscular.`;
                    weeklyGoals = [
                        { id: 1, text: 'Maximizar la ingesta de carbohidratos complejos antes del entrenamiento.' },
                        { id: 2, text: 'Consumir proteínas y carbohidratos simples después del ejercicio para la recuperación.' },
                        { id: 3, text: 'Mantenerse hiperhidratado antes, durante y después del ejercicio.' },
                        { id: 4, text: 'Experimentar con estrategias de nutrición deportiva (ej. carga de carbohidratos).' },
                    ];
                    dietMethod = [
                        '**Pre-entrenamiento:** Avena con plátano y un poco de miel.',
                        '**Post-entrenamiento:** Batido de proteínas y carbohidratos (jugo de fruta, pan blanco).',
                        '**Comidas principales:** Pastas integrales, arroz, patatas, proteínas magras y vegetales.',
                        '**Snacks:** Barras energéticas, frutas, frutos secos, sándwiches de pavo.',
                        '**Principios:** Timing nutricional, calidad de los carbohidratos, y reposición de electrolitos.',
                    ];
                    break;

                case 'obesity':
                    suggestion += `\n**Advertencia Importante:** Tu IMC (${imc.toFixed(1)}) indica obesidad. Es **crucial** que busques la supervisión de un **médico y un nutricionista certificado** para un plan seguro y efectivo. Esta guía es solo informativa.\n\nPara el **manejo de la obesidad**, te ofrecemos un plan que se enfoca en una reducción calórica controlada (aproximadamente ${Math.round(get - 500)}-${Math.round(get - 750)} kcal), alta en nutrientes, y el desarrollo de hábitos sostenibles.`;
                    weeklyGoals = [
                        { id: 1, text: 'Consultar con un médico para una evaluación completa de salud.' },
                        { id: 2, text: 'Establecer metas de pérdida de peso realistas (0.5-1 kg por semana).' },
                        { id: 3, text: 'Priorizar alimentos integrales, verduras, frutas y proteínas magras.' },
                        { id: 4, text: 'Incrementar gradualmente la actividad física (caminatas, actividades de bajo impacto).' },
                    ];
                    dietMethod = [
                        '**Desayuno:** Omelette de claras con vegetales.',
                        '**Media Mañana:** Puñado de frutos rojos.',
                        '**Almuerzo:** Pescado al vapor con ensalada abundante.',
                        '**Media Tarde:** Yogur desnatado.',
                        '**Cena:** Pechuga de pavo a la plancha con espárragos.',
                        '**Principios:** Control estricto de porciones, evitar bebidas calóricas, registrar la ingesta de alimentos.',
                    ];
                    if (expertAnswers.healthComplications === 'Sí') {
                        suggestion += '\n**ATENCIÓN:** Dada la presencia de complicaciones de salud, la supervisión médica es absolutamente indispensable. No inicies ningún cambio drástico sin aprobación médica.';
                    }
                    disclaimer += '\n**Esta recomendación es especialmente sensible para tu condición. La consulta profesional es obligatoria.**';
                    break;

                case 'undernutrition':
                    suggestion += `\n**Advertencia Importante:** Tu IMC (${imc.toFixed(1)}) indica desnutrición. Es **crucial** que busques la supervisión de un **médico y un nutricionista certificado** para un plan seguro y efectivo. Esta guía es solo informativa.\n\nPara el **manejo de la desnutrición**, te proponemos un plan para aumentar tu ingesta calórica y proteica de forma saludable (${Math.round(get + 500)}-${Math.round(get + 1000)} kcal, ajustando según necesidad), priorizando alimentos densos en nutrientes.`;
                    weeklyGoals = [
                        { id: 1, text: 'Consultar con un médico para identificar la causa subyacente de la desnutrición.' },
                        { id: 2, text: 'Consumir comidas frecuentes y ricas en nutrientes.' },
                        { id: 3, text: 'Incorporar fuentes de grasas saludables y proteínas en cada comida.' },
                        { id: 4, text: 'Aumentar gradualmente el tamaño de las porciones.' },
                    ];
                    dietMethod = [
                        '**Desayuno:** Batido con avena, plátano, mantequilla de maní y leche entera.',
                        '**Media Mañana:** Puñado grande de frutos secos y frutas deshidratadas.',
                        '**Almuerzo:** Guiso de lentejas con carne y patatas.',
                        '**Media Tarde:** Yogur griego entero con granola.',
                        '**Cena:** Pasta con salsa boloñesa y queso parmesano.',
                        '**Principios:** Alimentos con alta densidad calórica y nutritiva, no saltarse comidas, añadir calorías extra a las comidas (ej. aceite, crema).',
                    ];
                    if (expertAnswers.fatigueWeakness === 'Sí, frecuentemente') {
                        suggestion += '\nLa fatiga y debilidad pueden ser síntomas de deficiencias graves. Por favor, busca atención médica de inmediato.';
                    }
                    disclaimer += '\n**Esta recomendación es especialmente sensible para tu condición. La consulta profesional es obligatoria.**';
                    break;

                default:
                    suggestion = `Hola ${name}, no se ha seleccionado un objetivo específico o tu caso es especial. Por favor, asegúrate de elegir un objetivo para recibir una guía.`;
                    weeklyGoals = [{ id: 1, text: 'Por favor, selecciona un objetivo para recibir tu plan personalizado.' }];
                    dietMethod = ['No hay plan disponible sin un objetivo seleccionado.'];
                    break;
            }

            return { suggestion, weeklyGoals, dietMethod, disclaimer };
        }

      
        let currentStep = 0; // 0: Home, 1: Datos Iniciales, 2: Objetivo, 3: Preguntas Expertas, 4: Resultados
        let userData = {
            name: '',
            gender: '',
            age: '',
            height: '',
            weight: '',
            ailments: '',
            selectedGoal: null,
        };
        let expertAnswers = {};
        let metrics = null;
        let results = null;

        // --- Funciones para Renderizar Vistas ---

        function renderHome() {
            appDiv.innerHTML = `
                <div class="logo-area">
                    <img src="img/Logo.png" alt="Logo NutriCoach">
                </div>
                <h1>Tu Guía Nutricional Personalizada</h1>
                <p>Descubre un plan alimenticio adaptado a tus necesidades y objetivos de salud.</p>
                <button onclick="nextStep(1)">Comenzar mi Asesoría</button>
            `;
        }

        function renderInitialDataForm() {
            let formHtml = `
                <h2>1. Cuéntanos sobre ti</h2>
                <div class="form-group">
                    <label for="name">Nombre y Apellido</label>
                    <input type="text" id="name" name="name" value="${userData.name}" required>
                </div>
            `;
            initialQuestions.forEach(q => {
                formHtml += `<div class="form-group">
                    <label for="${q.id}">${q.label}</label>`;
                if (q.type === 'select') {
                    formHtml += `<select id="${q.id}" name="${q.id}" ${q.required ? 'required' : ''}>
                        <option value="">Selecciona...</option>`;
                    q.options.forEach(opt => {
                        formHtml += `<option value="${opt}" ${userData[q.id] === opt ? 'selected' : ''}>${opt}</option>`;
                    });
                    formHtml += `</select>`;
                } else if (q.type === 'textarea') {
                    formHtml += `<textarea id="${q.id}" name="${q.id}" ${q.required ? 'required' : ''}>${userData[q.id] || ''}</textarea>`;
                } else {
                    formHtml += `<input type="${q.type}" id="${q.id}" name="${q.id}" value="${userData[q.id] || ''}" ${q.required ? 'required' : ''} ${q.min ? 'min="' + q.min + '"' : ''} ${q.max ? 'max="' + q.max + '"' : ''}>`;
                }
                formHtml += `</div>`;
            });
            formHtml += `<button onclick="submitInitialData()">Siguiente</button>`;
            appDiv.innerHTML = formHtml;

          
            document.getElementById('name').addEventListener('input', (e) => userData.name = e.target.value);
            initialQuestions.forEach(q => {
                const element = document.getElementById(q.id);
                if (element) {
                    element.addEventListener('input', (e) => userData[q.id] = e.target.value);
                }
            });
        }

        function submitInitialData() {
            const { name, gender, age, height, weight } = userData;
            if (!name || !gender || !age || !height || !weight) {
                alert('Por favor, completa todos los campos obligatorios.');
                return;
            }
            metrics = calculateMetrics(userData.gender, parseFloat(userData.age), parseFloat(userData.height), parseFloat(userData.weight));
            nextStep(2);
        }

        function renderGoalSelection() {
            let optionsHtml = `
                <h2>2. ¿Cuál es tu objetivo nutricional principal?</h2>
                <div class="option-card-group">
            `;
            nutritionalGoals.forEach(goal => {
                const isSelected = userData.selectedGoal === goal.id ? 'selected' : '';
                optionsHtml += `
                    <div class="option-card ${isSelected}" data-goal-id="${goal.id}" onclick="selectGoal('${goal.id}')">
                        <img src="${goal.image}" alt="${goal.name} icon">
                        <h3>${goal.name}</h3>
                    </div>
                `;
            });
            optionsHtml += `</div>
                <button onclick="continueToExpertQuestions()" ${!userData.selectedGoal ? 'disabled' : ''}>
                    Continuar
                </button>
            `;
            appDiv.innerHTML = optionsHtml;
        }

        function selectGoal(goalId) {
            userData.selectedGoal = goalId;
            renderGoalSelection(); 
        }

        function continueToExpertQuestions() {
            if (userData.selectedGoal) {
                nextStep(3);
            } else {
                alert('Por favor, selecciona tu objetivo nutricional.');
            }
        }

        function renderExpertQuestions() {
            const currentQuestions = expertQuestions[userData.selectedGoal];
            if (!currentQuestions) {
                appDiv.innerHTML = `<h2>Error</h2><p>No se encontraron preguntas para este objetivo. <button onclick="nextStep(0)">Volver al Inicio</button></p>`;
                return;
            }

            let questionsHtml = `<h2>3. Más preguntas para personalizar tu plan</h2>`;
            currentQuestions.forEach(q => {
                questionsHtml += `<div class="form-group">
                    <label for="${q.id}">${q.label}</label>`;
                if (q.type === 'radio') {
                    questionsHtml += `<div class="button-group" style="justify-content: flex-start;">`;
                    q.options.forEach(opt => {
                        const isSelected = expertAnswers[q.id] === opt ? 'selected' : '';
                        const bgColor = expertAnswers[q.id] === opt ? 'var(--secondary-color)' : 'var(--bg-dark)';
                        const textColor = expertAnswers[q.id] === opt ? 'white' : 'var(--text-color)';
                        questionsHtml += `
                            <button
                                class="${isSelected}"
                                onclick="setExpertAnswer('${q.id}', '${opt}')"
                                style="background-color: ${bgColor}; color: ${textColor};"
                            >
                                ${opt}
                            </button>
                        `;
                    });
                    questionsHtml += `</div>`;
                } else if (q.type === 'select') {
                    questionsHtml += `<select id="${q.id}" name="${q.id}" onchange="setExpertAnswer('${q.id}', this.value)" ${q.required ? 'required' : ''}>
                        <option value="">Selecciona...</option>`;
                    q.options.forEach(opt => {
                        questionsHtml += `<option value="${opt}" ${expertAnswers[q.id] === opt ? 'selected' : ''}>${opt}</option>`;
                    });
                    questionsHtml += `</select>`;
                } else if (q.type === 'textarea') {
                    questionsHtml += `<textarea id="${q.id}" name="${q.id}" oninput="setExpertAnswer('${q.id}', this.value)" ${q.required ? 'required' : ''}>${expertAnswers[q.id] || ''}</textarea>`;
                } else {
                    questionsHtml += `<input type="${q.type}" id="${q.id}" name="${q.id}" value="${expertAnswers[q.id] || ''}" oninput="setExpertAnswer('${q.id}', this.value)" ${q.required ? 'required' : ''} ${q.min ? 'min="' + q.min + '"' : ''} ${q.max ? 'max="' + q.max + '"' : ''}>`;
                }
                questionsHtml += `</div>`;
            });
            questionsHtml += `<button onclick="submitExpertQuestions()">Obtener mi Plan Nutricional</button>`;
            appDiv.innerHTML = questionsHtml;
        }

        function setExpertAnswer(questionId, value) {
            expertAnswers[questionId] = value;
            
            const questionType = expertQuestions[userData.selectedGoal].find(q => q.id === questionId)?.type;
            if (questionType === 'radio') {
                renderExpertQuestions();
            }
        }

        function submitExpertQuestions() {
            const currentQuestions = expertQuestions[userData.selectedGoal];
            for (const q of currentQuestions) {
                if (q.required && !expertAnswers[q.id]) {
                    alert('Por favor, responde todas las preguntas obligatorias.');
                    return;
                }
            }
            results = getNutriSuggestions(userData, metrics, expertAnswers);
            nextStep(4);
        }

        function renderResults() {
            if (!results) {
                appDiv.innerHTML = `<h2>Error</h2><p>No se pudieron generar los resultados. <button onclick="nextStep(0)">Volver al Inicio</button></p>`;
                return;
            }

            appDiv.innerHTML = `
                <div class="results-section">
                    <h2>¡Tu Plan Nutricional está Listo!</h2>
                    <p>${results.suggestion.replace(/\n/g, '<br>')}</p>

                    <h3>Tus Métricas:</h3>
                    <ul>
                        <li><i class="fa-solid fa-calculator"></i> <strong>IMC (Índice de Masa Corporal):</strong> ${metrics.imc.toFixed(2)}</li>
                        <li><i class="fa-solid fa-fire"></i> <strong>TMB (Tasa Metabólica Basal estimada):</strong> ${metrics.tmb.toFixed(0)} kcal/día</li>
                    </ul>

                    <h3>Objetivos Semanales:</h3>
                    <ul>
                        ${results.weeklyGoals.map(goal => `<li><i class="fa-solid fa-bullseye"></i> ${goal.text}</li>`).join('')}
                    </ul>

                    <h3>Método Alimenticio Semanal (Ejemplos y Principios):</h3>
                    <ul>
                        ${results.dietMethod.map(item => `<li><i class="fa-solid fa-utensils"></i> ${item}</li>`).join('')}
                    </ul>

                    <div class="disclaimer">
                        <p><strong>Aviso Importante:</strong></p>
                        <p>${results.disclaimer}</p>
                    </div>

                    <div class="button-group">
                        <button onclick="downloadPlan()">Descargar Plan (.txt)</button>
                        <button onclick="resetApp()">Comenzar de Nuevo</button>
                    </div>
                </div>
            `;
        }

        function downloadPlan() {
            const planContent = `
NutriCoach - Tu Plan Nutricional Personalizado

---
${results.suggestion.replace(/<[^>]*>?/gm, '')}

---
Tu IMC: ${metrics.imc.toFixed(2)}
Tu TMB (Tasa Metabólica Basal): ${metrics.tmb.toFixed(0)} kcal/día

---
Objetivos Semanales:
${results.weeklyGoals.map(goal => `- ${goal.text}`).join('\n')}

---
Método Alimenticio Semanal (Ejemplos):
${results.dietMethod.map(item => `- ${item}`).join('\n')}

---
Aviso Importante:
${results.disclaimer}
            `;

            const blob = new Blob([planContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NutriCoach_Plan_${userData.name.replace(/\s/g, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function resetApp() {
            currentStep = 0;
            userData = {
                name: '',
                gender: '',
                age: '',
                height: '',
                weight: '',
                ailments: '',
                selectedGoal: null,
            };
            expertAnswers = {};
            metrics = null;
            results = null;
            renderApp();
        }

        
        function renderApp() {
            switch (currentStep) {
                case 0:
                    renderHome();
                    break;
                case 1:
                    renderInitialDataForm();
                    break;
                case 2:
                    renderGoalSelection();
                    break;
                case 3:
                    renderExpertQuestions();
                    break;
                case 4:
                    renderResults();
                    break;
                default:
                    renderHome();
            }
        }

        function nextStep(stepNum) {
            currentStep = stepNum;
            renderApp();
        }

       
        document.addEventListener('DOMContentLoaded', renderApp);
    </script>
</body>
</html>